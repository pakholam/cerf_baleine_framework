"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.compress = void 0;
const fs_1 = __importDefault(require("fs"));
const https_1 = __importDefault(require("https"));
const path_1 = __importDefault(require("path"));
const url_1 = __importDefault(require("url"));
const exts = ['.png', '.jpg', '.jpeg'];
const max = 5200000;
const options = {
    method: 'POST',
    hostname: 'tinypng.com',
    path: '/backend/opt/shrink',
    headers: {
        rejectUnauthorized: 'false',
        'Postman-Token': Date.now(),
        'Cache-Control': 'no-cache',
        'Content-Type': 'application/x-www-form-urlencoded',
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36'
    }
};
function compress(filePath) {
    if (!fs_1.default.existsSync(filePath)) {
        console.log(`路径不存在：${filePath}`);
        return;
    }
    const fileName = path_1.default.basename(filePath);
    if (!fs_1.default.statSync(filePath).isDirectory()) {
        if (exts.includes(path_1.default.extname(filePath))) {
            console.log(`[${fileName}] 压缩中...`);
            fileTinyUpload(filePath)
                .then(data => {
                console.log(`[1/1] [${fileName}] 压缩成功，原始: ${toSize(data.input.size)}，压缩: ${toSize(data.output.size)}，压缩比: ${toPercent(data.output.ratio)}`);
            })
                .catch(err => {
                console.log(`[1/1] [${fileName}] 压缩失败！报错：${err}`);
            });
        }
        else {
            console.log(`[${fileName}] 压缩失败！报错：只支持 png、jpg 与 jpeg 格式`);
        }
    }
    else {
        let totalCount = 0;
        let processedCount = 0;
        fileEach(filePath, (filePathInDir) => {
            totalCount++;
            const relativePath = path_1.default.relative(filePath, filePathInDir);
            fileTinyUpload(filePathInDir)
                .then(data => {
                console.log(`[${++processedCount}/${totalCount}] [${relativePath}] 压缩成功，原始: ${toSize(data.input.size)}，压缩: ${toSize(data.output.size)}，压缩比: ${toPercent(data.output.ratio)}`);
            })
                .catch(err => {
                console.log(`[${++processedCount}/${totalCount}] [${relativePath}] 压缩失败！报错：${err}`);
            });
        });
    }
}
exports.compress = compress;
function getRandomIP() {
    return Array.from(Array(4)).map(() => Math.floor(255 * Math.random())).join('.');
}
function fileEach(dir, callback) {
    fs_1.default.readdir(dir, (err, files) => {
        if (err) {
            console.error(err);
            return;
        }
        files.forEach((file) => {
            const filePath = path_1.default.join(dir, file);
            fs_1.default.stat(filePath, (statErr, stats) => {
                if (statErr) {
                    console.error(statErr);
                    return;
                }
                if (stats.isDirectory()) {
                    fileEach(filePath, callback);
                }
                else {
                    if (stats.size <= max && stats.isFile() && exts.includes(path_1.default.extname(file))) {
                        callback(filePath);
                    }
                }
            });
        });
    });
}
function fileUpload(filePath) {
    return new Promise((resolve, reject) => {
        options.headers['X-Forwarded-For'] = getRandomIP();
        const req = https_1.default.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => {
                data += chunk;
            });
            res.on('end', () => {
                try {
                    const result = JSON.parse(data);
                    if (result.error) {
                        reject(result.message);
                    }
                    else {
                        resolve(result);
                    }
                }
                catch (parseErr) {
                    reject(parseErr);
                }
            });
        });
        req.write(fs_1.default.readFileSync(filePath), 'binary');
        req.on('error', err => {
            reject(err);
        });
        req.end();
    });
}
function fileUpdate(filePath, data) {
    return new Promise((resolve, reject) => {
        const urlObj = new url_1.default.URL(data.output.url);
        const req = https_1.default.request(urlObj, (res) => {
            let body = '';
            res.setEncoding('binary');
            res.on('data', (chunk) => {
                body += chunk;
            });
            res.on('end', () => {
                fs_1.default.writeFile(filePath, body, 'binary', (err) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
        });
        req.on('error', (err) => {
            reject(err);
        });
        req.end();
    });
}
function fileTinyUpload(filePath) {
    return fileUpload(filePath).then(data => fileUpdate(filePath, data));
}
function toSize(size) {
    if (size < 1024)
        return size + 'B';
    else if (size < 1048576)
        return (size / 1024).toFixed(2) + 'KB';
    else
        return (size / 1024 / 1024).toFixed(2) + 'MB';
}
function toPercent(ratio) {
    return (100 * ratio).toFixed(2) + '%';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGlueXBuZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NvdXJjZS90aW55cG5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRDQUFvQjtBQUNwQixrREFBMEI7QUFDMUIsZ0RBQXdCO0FBQ3hCLDhDQUFzQjtBQUV0QixNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDdkMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDO0FBQ3BCLE1BQU0sT0FBTyxHQUFRO0lBQ2pCLE1BQU0sRUFBRSxNQUFNO0lBQ2QsUUFBUSxFQUFFLGFBQWE7SUFDdkIsSUFBSSxFQUFFLHFCQUFxQjtJQUMzQixPQUFPLEVBQUU7UUFDTCxrQkFBa0IsRUFBRSxPQUFPO1FBQzNCLGVBQWUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQzNCLGVBQWUsRUFBRSxVQUFVO1FBQzNCLGNBQWMsRUFBRSxtQ0FBbUM7UUFDbkQsWUFBWSxFQUFFLDhHQUE4RztLQUMvSDtDQUNKLENBQUM7QUFFRixTQUFnQixRQUFRLENBQUMsUUFBZ0I7SUFDckMsSUFBSSxDQUFDLFlBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7UUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDakMsT0FBTztLQUNWO0lBQ0QsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN6QyxJQUFJLENBQUMsWUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUN0QyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFO1lBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLFVBQVUsQ0FBQyxDQUFDO1lBQ3BDLGNBQWMsQ0FB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TTt3QkFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQ2pCO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBUSxFQUFFLEVBQUU7WUFDekIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ2QsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsUUFBZ0I7SUFDcEMsT0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ3pFLENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBQyxJQUFZO0lBQ3hCLElBQUksSUFBSSxHQUFHLElBQUk7UUFDWCxPQUFPLElBQUksR0FBRyxHQUFHLENBQUM7U0FDakIsSUFBSSxJQUFJLEdBQUcsT0FBTztRQUNuQixPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7O1FBRXZDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7QUFDdEQsQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEtBQWE7SUFDNUIsT0FBTyxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQzFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xyXG5cclxuY29uc3QgZXh0cyA9IFsnLnBuZycsICcuanBnJywgJy5qcGVnJ107XHJcbmNvbnN0IG1heCA9IDUyMDAwMDA7XHJcbmNvbnN0IG9wdGlvbnM6IGFueSA9IHtcclxuICAgIG1ldGhvZDogJ1BPU1QnLFxyXG4gICAgaG9zdG5hbWU6ICd0aW55cG5nLmNvbScsXHJcbiAgICBwYXRoOiAnL2JhY2tlbmQvb3B0L3NocmluaycsXHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgcmVqZWN0VW5hdXRob3JpemVkOiAnZmFsc2UnLFxyXG4gICAgICAgICdQb3N0bWFuLVRva2VuJzogRGF0ZS5ub3coKSxcclxuICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1jYWNoZScsXHJcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnLFxyXG4gICAgICAgICdVc2VyLUFnZW50JzogJ01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS81Ni4wLjI5MjQuODcgU2FmYXJpLzUzNy4zNidcclxuICAgIH1cclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wcmVzcyhmaWxlUGF0aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOi3r+W+hOS4jeWtmOWcqO+8miR7ZmlsZVBhdGh9YCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGVQYXRoKTtcclxuICAgIGlmICghZnMuc3RhdFN5bmMoZmlsZVBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICBpZiAoZXh0cy5pbmNsdWRlcyhwYXRoLmV4dG5hbWUoZmlsZVBhdGgpKSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7ZmlsZU5hbWV9XSDljovnvKnkuK0uLi5gKTtcclxuICAgICAgICAgICAgZmlsZVRpbnlVcGxvYWQoZmlsZVBhdGgpXHJcbiAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWzEvMV0gWyR7ZmlsZU5hbWV9XSDljovnvKnmiJDlip/vvIzljp/lp4s6ICR7dG9TaXplKGRhdGEuaW5wdXQuc2l6ZSl977yM5Y6L57ypOiAke3RvU2l6ZShkYXRhLm91dHB1dC5zaXplKX3vvIzljovnvKnmr5Q6ICR7dG9QZXJjZW50KGRhdGEub3V0cHV0LnJhdGlvKX1gKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWzEvMV0gWyR7ZmlsZU5hbWV9XSDljovnvKnlpLHotKXvvIHmiqXplJnvvJoke2Vycn1gKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYFske2ZpbGVOYW1lfV0g5Y6L57yp5aSx6LSl77yB5oql6ZSZ77ya5Y+q5pSv5oyBIHBuZ+OAgWpwZyDkuI4ganBlZyDmoLzlvI9gKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBsZXQgdG90YWxDb3VudCA9IDA7XHJcbiAgICAgICAgbGV0IHByb2Nlc3NlZENvdW50ID0gMDtcclxuICAgICAgICBmaWxlRWFjaChmaWxlUGF0aCwgKGZpbGVQYXRoSW5EaXIpID0+IHtcclxuICAgICAgICAgICAgdG90YWxDb3VudCsrO1xyXG4gICAgICAgICAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBwYXRoLnJlbGF0aXZlKGZpbGVQYXRoLCBmaWxlUGF0aEluRGlyKTtcclxuICAgICAgICAgICAgZmlsZVRpbnlVcGxvYWQoZmlsZVBhdGhJbkRpcilcclxuICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHsrK3Byb2Nlc3NlZENvdW50fS8ke3RvdGFsQ291bnR9XSBbJHtyZWxhdGl2ZVBhdGh9XSDljovnvKnmiJDlip/vvIzljp/lp4s6ICR7dG9TaXplKGRhdGEuaW5wdXQuc2l6ZSl977yM5Y6L57ypOiAke3RvU2l6ZShkYXRhLm91dHB1dC5zaXplKX3vvIzljovnvKnmr5Q6ICR7dG9QZXJjZW50KGRhdGEub3V0cHV0LnJhdGlvKX1gKTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7Kytwcm9jZXNzZWRDb3VudH0vJHt0b3RhbENvdW50fV0gWyR7cmVsYXRpdmVQYXRofV0g5Y6L57yp5aSx6LSl77yB5oql6ZSZ77yaJHtlcnJ9YCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0UmFuZG9tSVAoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBBcnJheS5mcm9tKEFycmF5KDQpKS5tYXAoKCkgPT4gTWF0aC5mbG9vcigyNTUgKiBNYXRoLnJhbmRvbSgpKSkuam9pbignLicpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaWxlRWFjaChkaXI6IHN0cmluZywgY2FsbGJhY2s6IChmaWxlUGF0aDogc3RyaW5nKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICBmcy5yZWFkZGlyKGRpciwgKGVycjogYW55LCBmaWxlczogYW55W10pID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmaWxlcy5mb3JFYWNoKChmaWxlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4oZGlyLCBmaWxlKTtcclxuICAgICAgICAgICAgZnMuc3RhdChmaWxlUGF0aCwgKHN0YXRFcnI6IGFueSwgc3RhdHM6IHsgaXNEaXJlY3Rvcnk6ICgpID0+IGFueTsgc2l6ZTogbnVtYmVyOyBpc0ZpbGU6ICgpID0+IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRFcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHN0YXRFcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZUVhY2goZmlsZVBhdGgsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0cy5zaXplIDw9IG1heCAmJiBzdGF0cy5pc0ZpbGUoKSAmJiBleHRzLmluY2x1ZGVzKHBhdGguZXh0bmFtZShmaWxlKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZmlsZVVwbG9hZChmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgb3B0aW9ucy5oZWFkZXJzWydYLUZvcndhcmRlZC1Gb3InXSA9IGdldFJhbmRvbUlQKCk7XHJcbiAgICAgICAgY29uc3QgcmVxID0gaHR0cHMucmVxdWVzdChvcHRpb25zLCAocmVzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgbGV0IGRhdGEgPSAnJztcclxuICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgIGRhdGEgKz0gY2h1bms7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXMub24oJ2VuZCcsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXN1bHQubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHBhcnNlRXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHBhcnNlRXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVxLndyaXRlKGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCksICdiaW5hcnknKTtcclxuICAgICAgICByZXEub24oJ2Vycm9yJywgZXJyID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVxLmVuZCgpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbGVVcGRhdGUoZmlsZVBhdGg6IHN0cmluZywgZGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgdXJsT2JqID0gbmV3IHVybC5VUkwoZGF0YS5vdXRwdXQudXJsKTtcclxuICAgICAgICBjb25zdCByZXEgPSBodHRwcy5yZXF1ZXN0KHVybE9iaiwgKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBib2R5ID0gJyc7XHJcbiAgICAgICAgICAgIHJlcy5zZXRFbmNvZGluZygnYmluYXJ5Jyk7XHJcbiAgICAgICAgICAgIHJlcy5vbignZGF0YScsIChjaHVuazogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBib2R5ICs9IGNodW5rO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGUoZmlsZVBhdGgsIGJvZHksICdiaW5hcnknLCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJlcS5vbignZXJyb3InLCAoZXJyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmVxLmVuZCgpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbGVUaW55VXBsb2FkKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIGZpbGVVcGxvYWQoZmlsZVBhdGgpLnRoZW4oZGF0YSA9PiBmaWxlVXBkYXRlKGZpbGVQYXRoLCBkYXRhKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRvU2l6ZShzaXplOiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgaWYgKHNpemUgPCAxMDI0KVxyXG4gICAgICAgIHJldHVybiBzaXplICsgJ0InO1xyXG4gICAgZWxzZSBpZiAoc2l6ZSA8IDEwNDg1NzYpXHJcbiAgICAgICAgcmV0dXJuIChzaXplIC8gMTAyNCkudG9GaXhlZCgyKSArICdLQic7XHJcbiAgICBlbHNlXHJcbiAgICAgICAgcmV0dXJuIChzaXplIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMikgKyAnTUInO1xyXG59XHJcblxyXG5mdW5jdGlvbiB0b1BlcmNlbnQocmF0aW86IG51bWJlcik6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gKDEwMCAqIHJhdGlvKS50b0ZpeGVkKDIpICsgJyUnO1xyXG59Il19